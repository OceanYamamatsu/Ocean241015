```mermaid
flowchart TD
  Start([開始])
  Init[初期化: センサー較正、閾値(threshold)設定、モーター停止、変数初期化]
  LoopStart((ループ開始))
  Read[光センサー読み取り\nLeft = readSensor(LEFT)\nRight = readSensor(RIGHT)]
  CheckEStop{非常停止スイッチ\nまたは障害検知？}
  EStopAction[モーター停止 -> 状態レポート -> 終了/待機]
  BothDetect{Left >= TH && Right >= TH ?}
  IntersectionCheck{交差点判定(両方長時間検出)？}
  IntersectionAction[交差点処理: 指定動作(直進/右折/左折/一時停止) -> ログ/カウント増加]
  MoveStraight[直進: 左モーター = SPEED, 右モーター = SPEED]
  LeftOnly{Left >= TH && Right < TH ?}
  TurnLeft[左寄り修正: 左モーター = LOW, 右モーター = HIGH]
  RightOnly{Right >= TH && Left < TH ?}
  TurnRight[右寄り修正: 左モーター = HIGH, 右モーター = LOW]
  Neither{Left < TH && Right < TH ?}
  Search[探索モード: 停止して後退または回転（例: 左回転） -> 少し待つ -> 再測定]
  LoopEnd((次ループへ))

  Start --> Init --> LoopStart --> Read --> CheckEStop
  CheckEStop -- はい --> EStopAction
  CheckEStop -- いいえ --> BothDetect

  BothDetect -- はい --> IntersectionCheck
  IntersectionCheck -- はい --> IntersectionAction --> LoopEnd
  IntersectionCheck -- いいえ --> MoveStraight --> LoopEnd

  BothDetect -- いいえ --> LeftOnly
  LeftOnly -- はい --> TurnLeft --> LoopEnd
  LeftOnly -- いいえ --> RightOnly
  RightOnly -- はい --> TurnRight --> LoopEnd
  RightOnly -- いいえ --> Neither
  Neither -- はい --> Search --> LoopEnd

  LoopEnd --> LoopStart

```